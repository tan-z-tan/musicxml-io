# ABC Round-trip Fix Plan

30個の round-trip テストが全て失敗している。修正対象は `src/importers/abc.ts` (パーサー) と `src/exporters/abc.ts` (シリアライザ)。

## 修正一覧

### 1. L: 単位音符長の保存・復元 (20+ テストに影響)

**問題**: シリアライザが常に `computeUnitNoteLength()` で `L:1/8` を再計算する。`L:1/4` の曲で全音符の長さ文字列が倍になる（例: `C` → `C2`）。

**修正**:
- パーサー: `abc-unit-note-length` を `score.metadata.miscellaneous` に保存
- シリアライザ: 保存された値を使用し、計算をフォールバックにする

### 2. ヘッダーフィールド保存 (8テストに影響)

**問題**: R:, S:, N:, I:, %%MIDI, %%staves がパース時に破棄される。

**影響ファイル**: piano.abc, tune_008268.abc, tune_009270.abc, real-cooleys-reel.abc, real-kesh-jig.abc, real-irish-washerwoman.abc, real-si-bheag.abc, real-star-county-down.abc

**修正**:
- パーサー: `parseHeader()` で未知フィールドを `abc-header-{field}` として miscellaneous に保存。%%ディレクティブも同様に保存
- シリアライザ: T:/C: の後、K: の前に保存されたフィールドを出力

### 3. ノート間スペース保存 (~10テストに影響)

**問題**: `EBBA B2 EB` のスペースがトークナイザで破棄され、シリアライザは `EBBAB2EB` を出力する。

**影響ファイル**: durations.abc, real-cooleys-reel.abc, real-kesh-jig.abc, real-irish-washerwoman.abc, real-dotted-rhythms.abc, real-complex-keys.abc, tune_009270.abc, piano.abc

**修正**:
- パーサー `tokenizeMusicLine()`: スペースを `{ type: 'space' }` トークンとして保持
- パーサー `buildMeasures()`: 各ノートエントリに `abcSpaceBefore: true` フラグを付与
- シリアライザ: フラグがあるノートの前にスペースを出力

### 4. Voice ID 保存 (2テストに影響)

**問題**: シリアライザが `V:{partIdx+1}` (V:1, V:2) を出力する。元の ID (V:V1, V:P1) が失われる。

**影響ファイル**: piano.abc (V:V1), tune_009270.abc (V:P1)

**修正**:
- パーサー: `partList` エントリの `id` に元の voice ID を保存（既に `voiceIds` はある）
- シリアライザ: `score.partList` から voice ID を読み取って使用

### 5. Q: テンポ形式保存 (1テストに影響)

**問題**: `Q:3/8=120` がパース時に beatUnit=`eighth` に変換され、シリアライザが `Q:1/8=120` ではなく `Q:1/4=...` のような別形式で出力する。

**影響ファイル**: real-irish-washerwoman.abc

**修正**:
- パーサー: `abc-tempo` を miscellaneous に保存
- シリアライザ: 保存された Q: 文字列をそのまま出力

### 6. タプレット記法 (1テストに影響)

**問題**: `(3CDE` が `C2/3D2/3E2/3` のような分数表記に展開される。

**影響ファイル**: tuplets.abc

**修正**:
- シリアライザ: `timeModification` を持つ連続ノートを検出し、`(p` プレフィックスを出力
- ノートの duration は tuplet 適用前の値で出力（q/p 倍を戻す）

### 7. 不可視レスト x (1テストに影響)

**問題**: `x` (不可視レスト) が `z` (可視レスト) として出力される。

**影響ファイル**: piano.abc

**修正**:
- パーサー: rest オブジェクトに `printObject: false` を設定
- シリアライザ: フラグを見て `x` を出力

### 8. グレースノートグループ化 (1テストに影響)

**問題**: `{DE}` が `{D}{E}` として個別に出力される。

**影響ファイル**: grace-notes.abc

**修正**:
- シリアライザ: 連続する grace ノートを検出し、単一の `{...}` でグループ化

### 9. Volta 記号 [1, [2 (1テストに影響)

**問題**: volta ending マーカーの出力位置・形式が不正。

**影響ファイル**: repeats.abc

**修正**:
- シリアライザ `serializeBarline()`: ending が left barline にある場合、`[1` を正しい位置に出力
- ending.type === 'start' の場合は barline の後に `[N ` を付加

### 10. 歌詞インターリーブ (3テストに影響)

**問題**: `w:` 行がパート末尾にまとめて出力される。元は音楽行の直後に配置。

**影響ファイル**: lyrics.abc, real-amazing-grace.abc, real-scarborough-fair.abc

**修正**:
- シリアライザ: 歌詞を持つノートが含まれる小節の後に `w:` 行を出力
- 各音楽行の後に対応する歌詞行を挿入する形に変更

### 11. 行継続バックスラッシュ (1テストに影響)

**問題**: `\` 行継続マーカーが失われる。

**影響ファイル**: tune_008268.abc

**修正**:
- パーサー: 行継続位置（小節番号）を miscellaneous に保存
- シリアライザ: 該当小節の後に `\` + 改行を出力

### 12. インライン [V: P1] マーカー (1テストに影響)

**問題**: tune_009270.abc は `[V: P1]` インライン形式を使うが、シリアライザはスタンドアロン `V:1` を出力する。

**修正**:
- パーサー: インライン vs スタンドアロンの voice 形式を miscellaneous に保存
- シリアライザ: インライン形式が保存されていれば `[V: {id}]` を出力

### 13. 特殊バーライン |>| (1テストに影響)

**問題**: tune_008268.abc の末尾 `|>|` が通常の `|` になる。

**修正**:
- パーサー: `|>|` をバーラインタイプとして認識・保存
- シリアライザ: 対応するバーラインスタイルから `|>|` を復元

### 14. インライン K: キー変更 (1テストに影響)

**問題**: real-complex-keys.abc に本文中の `K:Bb` があるが、シリアライズ時に失われる。

**修正**:
- パーサー: インライン K: をアトリビュート変更エントリとして保存（既存の attributes エントリ機構を使用）
- シリアライザ: アトリビュート変更を検出し `K:` 行を出力

### 15. バーライン前後スペース (複数テストに影響)

**問題**: ` | ` (スペース付き) が `|` になる。` :|` が `:|` になる。

**修正**: #3 のスペース保存と同様に、バーライン前後のスペースも保存・復元

### 16. = ナチュラル記号の保存

**問題**: `=E`（明示的ナチュラル）が `E`（暗黙ナチュラル）として出力される可能性。

**修正**:
- パーサー: 明示的 natural を alter=0 + explicit フラグで保存
- シリアライザ: explicit フラグがあれば `=` を出力

## 実装順序（インパクト順）

| 順序 | 修正項目 | 修正テスト数 |
|------|----------|-------------|
| 1 | L: 保存・復元 | ~20 |
| 2 | ヘッダーフィールド保存 | +8 |
| 3 | スペース保存 | +10 |
| 4 | Voice ID 保存 | +2 |
| 5 | タプレット記法 | +1 |
| 6 | グレースノートグループ化 | +1 |
| 7 | Q: テンポ形式保存 | +1 |
| 8 | 不可視レスト x | +1 |
| 9 | 歌詞インターリーブ | +3 |
| 10 | Volta 記号 | +1 |
| 11 | 行継続 \ | +1 |
| 12 | インライン V: | +1 |
| 13 | 特殊バーライン | +1 |
| 14 | インライン K: | +1 |
| 15 | バーラインスペース | 上記に含む |
| 16 | ナチュラル記号 | 上記に含む |
